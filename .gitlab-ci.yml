image: docker:stable

stages:
- build
- test
- release

variables:
    PROJECT_NAME: bigrob8181/$CI_PROJECT_NAME
    DEV: $PROJECT_NAME:dev
    #TEST: $PROJECT_NAME:$CI_PIPELINE_IID
    RELEASE: $PROJECT_NAME:$CI_COMMIT_REF_NAME
    LATEST: $PROJECT_NAME:latest
    DOCKER_CONTAINER: $CI_PROJECT_NAME'_test'

before_script:
    - docker login -u="$DOCKERHUB_USERNAME" -p="$DOCKERHUB_PASSWORD"

# For Production
build_prod:
    stage: build
    script:
        - docker build --pull -t $RELEASE .
        #- docker push $RELEASE
    only:
        - tags

test_prod:
    stage: test
    #before_script:
    #    - docker pull $TEST
    script:
        - docker run --name $DOCKER_CONTAINER -d $RELEASE
        - docker ps -a | awk '{print $NF}' | grep -w $DOCKER_CONTAINER | cat
    after_script:
        - docker stop $DOCKER_CONTAINER && docker rm $DOCKER_CONTAINER
    only:
        - tags

release_prod:
    stage: release
    script:
        #- docker pull $TEST
        - docker tag $RELEASE $LATEST
        - docker push $PROJECT_NAME
    only:
        - tags


# For Development
build_dev:
    stage: build
    script:
        - docker build --pull -t $DEV .
        - docker push $DEV
    only:
        - master

test_dev:
    stage: test
    #before_script:
    #    - docker pull $TEST
    script:
        - docker run --name $DOCKER_CONTAINER -d $DEV
        - docker ps -a | awk '{print $NF}' | grep -w $DOCKER_CONTAINER | cat
    after_script:
        - docker stop $DOCKER_CONTAINER && docker rm $DOCKER_CONTAINER
    only:
        - master

release_dev:
    stage: release
    script:
        - docker push $DEV
    only:
        - master
